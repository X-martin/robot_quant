/**/

updateCodeSize();updateTabbleSize();$(window).resize(function(){updateCodeSize();updateTabbleSize()});$(window).bind("beforeunload",function(){if(building==1){return"有正在运行的回测，确定离开此页面吗？"}});$(window).bind("unload",function(){if(building==1){cancel()}});function updateCodeSize(){var a=$("header").eq(0);if(a.hasClass("hidden")){var e=0}else{var e=a.height()+$("#subnav").height()}var b=$("body").eq(0).height();var d=b-e-8;$("#ide-box").height(d);var c=$("#toolbar").height();$("#code-area").height(d);$("#code-area-internal").height(d-c)}function updateTabbleSize(){var e=$("#output-pane").height();var b=$("#dailybars-nav").height();if($(".dailybars-output .tabbable").hasClass("tall")){var c=0}else{var c=$("#dailybars-results").height()+10}var a=e-b-c-10;$("#tabbable").height(a);var d=$("#nav-tabs").height();$("#tab-content").height(a-d)}function build(a){clearStats();Cy.ajax("/algorithm/index/generate",{data:a,async:false,success:function(c){$("#log").find("pre").eq(0).html("");$("#error-log").find("pre").eq(0).html("");$("#daily-error-tab-link").find("i").addClass("hidden");$("#logs-init").removeClass("hidden");$("#daily-logs-link").click();$("#algorithmId").val(c.data.algorithmId);$("#edit-button").removeClass("disabled");$("#backtest-button").removeClass("disabled");backtestId=c.data.backtestId;var d=$("#startTime").val();var b=$("#endTime").val();g_tradeDays=c.data.tradeDays;initChart(d,b);run();return false},fail:function(b){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"快速回测失败:"+b.msg});building=0;return}});return false}var toggleNavbarFlag=0;function toggleNavbar(a){if(a){toggleNavbarFlag=a}if(toggleNavbarFlag==0){$("#dailybars-progressbar").width("0%");$("#setting-btn-group").addClass("hidden");$("#dailybars-status").removeClass("hidden");toggleNavbarFlag=1}else{$("#dailybars-progressbar").width("100%");$("#setting-btn-group").removeClass("hidden");$("#dailybars-status").addClass("hidden");toggleNavbarFlag=0}}$("#cancel-daily-backtest-button").click(function(){BootstrapDialog.confirm({title:"提示",btnCancelLabel:"取消",btnOKLabel:"确认",message:"确实要取消?",callback:function(a){if(a){cancel()}else{}}})});function cancel(){Cy.ajax("/algorithm/index/cancel",{data:"backtestId="+backtestId,async:false,success:function(a){stopCycle=true;toggleNavbar(1);$("#logs-init").addClass("hidden");building=0;return false},fail:function(a){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法取消:"+a.msg})}})}function run(){clearStats();toggleNavbar();var b=$("#startTime").val();var a=$("#endTime").val();initChart(b,a);stopCycle=false;stopResult=false;stopLog=false;stopErrorLog=false;cycleCount=0;cycleCheck()}var building=0;function unsave(){if(saving){return}$("#save-done-text").css("display","none");$("#save-span").removeClass("hidden");$("#save").removeAttr("disabled")}function getByteLen(e){var b=0;for(var d=0;d<e.length;d++){var c=e.charAt(d);if(c.match(/[^\x00-\xff]/ig)!=null){b+=2}else{b+=1}}return b}$(".algo-title").click(function(b){b.stopPropagation();$(this).addClass("hidden");$(".beta-label").addClass("hidden");$(".algo-title-box").removeClass("hidden").focus().val($(".algo-title").html());var a=getByteLen($("#title-box").val());$("#title-box").width(a*8+"px").css({"min-width":390,"max-width":1280})});$("#title-box").keydown(function(){var a=getByteLen($("#title-box").val());$("#title-box").width(a*8+"px").css({"min-width":390,"max-width":1280})});$("#title-box").blur(function(){$(".algo-title-box").addClass("hidden");var a=this;if($(this).val()!=""){$(".algo-title").html($(a).val())}$(".algo-title").removeClass("hidden");$(".beta-label").removeClass("hidden");$(document).attr("title",$(this).val())});$(document).attr("title",$(".algo-title").text());tab_pane_tall=0;$("#daily-toggle-logs-button").click(function(){tab_pane_tall?shrink_log_window():expand_log_window()});expand_log_window=function(){$tab_pane=$(".dailybars-output .tabbable");$tab_pane.addClass("tall");$("#daily-toggle-logs-button").removeClass("show_more");tab_pane_tall=!0;updateTabbleSize()};shrink_log_window=function(){$tab_pane=$(".dailybars-output .tabbable");$tab_pane.removeClass("tall");$("#daily-toggle-logs-button").addClass("show_more");tab_pane_tall=!1;updateTabbleSize()};$("#daily-error-tab-link").click(function(){$(this).find("i").addClass("hidden")});var chart;var resultOffset=0;var userRecordOffset=0;var logOffset=0;var errorLogOffset=0;var frequency="day";var stopCycle=false;var stopResult=false;var stopLog=false;var stopErrorLog=false;var backtestId=null;var dataResult=[];var dataBenchmark=[];var origDataOffset=0;var userRecord=null;var startDate=null;var endDate=null;Highcharts.setOptions({global:{timezoneOffset:-8*60},lang:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdays:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],rangeSelectorZoom:"",rangeSelectorFrom:"从",rangeSelectorTo:"到"}});var cycleCount=0;var timeoutSpan=4000;function cycleCheck(){if(stopResult&&stopErrorLog&&stopLog){stopCycle=true}if(stopCycle){return}if(stopLog==false){fillLog(backtestId)}if(stopErrorLog==false){fillErrorLog(backtestId)}if(stopResult==false){drawResult(backtestId)}cycleCount++;if(cycleCount<=4){setTimeout(cycleCheck,500*cycleCount)}else{setTimeout(cycleCheck,timeoutSpan)}}function clearStats(){$("#total_returns").html('<span class="no-message-2 no-message">');$("#benchmark_returns").html('<span class="no-message-1 no-message">');$("#alpha").html('<span class="no-message-3 no-message">');$("#beta").html('<span class="no-message-3 no-message">');$("#sharpe").html('<span class="no-message-3 no-message">');$("#max_drawdown").html('<span class="no-message-3 no-message">')}function fillStats(a){Cy.ajax("/algorithm/backtest/stats?backtestId="+backtestId,{success:function(b){if(!b.data){setTimeout(fillStats,500);return}$("#total_returns").html((b.data.algorithm_return*100).toFixed(2)+"%");$("#benchmark_returns").html((b.data.benchmark_return*100).toFixed(2)+"%");$("#alpha").html(b.data.alpha.toFixed(2));$("#beta").html(b.data.beta.toFixed(2));$("#sharpe").html(b.data.sharpe.toFixed(2));$("#max_drawdown").html((b.data.max_drawdown*100).toFixed(2)+"%")}})}function fillLog(a){Cy.ajax("/algorithm/backtest/log?backtestId="+a+"&offset="+logOffset,{success:function(h){if(h.data.logArr.length==0&&(h.data.state==2||h.data.state==3)){stopLog=true;return}if(h.data.offset<logOffset){return}var g="";for(var f=0;f<h.data.logArr.length;f++){if(!h.data.logArr[f]){continue}var e=h.data.logArr[f].split(" - ");if(e.length>2){var c='<span class="log-date">'+e[0]+"</span> - ";if(e[1]=="ERROR"){var j="log-error"}else{if(e[1]=="WARNING"){var j="log-warning"}else{var j="log-info"}}var b='<span class="'+j+'">'+e[1]+"</span> - ";e.shift();e.shift();var d=c+b+e.join("-")}else{var d=h.data.logArr[f]}g=g+"<p>"+d.replace(/\n/g,"<br/>");+"</p>";logOffset++}if(logOffset==0&&g.length>0){$("#logs-init").addClass("hidden")}$("#log").find("pre").eq(0).append(g)}})}function fillErrorLog(a){Cy.ajax("/algorithm/backtest/error?backtestId="+a+"&offset="+errorLogOffset,{success:function(d){if(d.data.logArr.length==0&&(d.data.state==2||d.data.state==3)){stopErrorLog=true;return}var c="";for(var b=0;b<d.data.logArr.length;b++){c=c+"<p>"+d.data.logArr[b].replace(/\n/g,"<br/>");+"</p>";errorLogOffset++}$("#error-log").find("pre").eq(0).append(c);if(c.length>0&&!$("#daily-errors-tab").hasClass("active")){$("#daily-error-tab-link").find("i").removeClass("hidden")}}})}function clearHighchartLable(){var a=document.domain;$("text[text-anchor=end]").each(function(){if(this.innerHTML=="Highcharts.com"){$(this).html(a)}})}function drawResult(a){stopResult=true;Cy.ajax("/algorithm/backtest/result?backtestId="+a+"&offset="+resultOffset+"&userRecordOffset="+userRecordOffset,{timeout:5000,fail:function(b){stopResult=false;return},error:function(b){stopResult=false},success:function(m){if(m.data.state==0){stopResult=false;return}else{if(m.data.state==3){toggleNavbar(1);building=0;$("#logs-init").addClass("hidden");$("#daily-error-tab-link").click();var g=0;var d=setInterval(function(){$("#error-log").css("display",g++%2?"none":"block");g>4&&(clearInterval(d))},150);return}}var l=m.data.result.benchmark;var e=m.data.result.overallReturn;var j=m.data.result.count;var f=parseInt(m.data.result.offset);console.log(m.data);if(j<=0&&m.data.state!=2){stopResult=false;return}if(!chart){chart=newChart(m.data.userRecord);clearHighchartLable()}if(m.data.userRecord){if(!userRecord){userRecord={};for(var k in m.data.userRecord){userRecord[k]=getRemainNullData()}}for(var k in m.data.userRecord){if(typeof userRecord[k]=="undefined"){userRecord[k]=getRemainNullData();chart.addSeries({name:k,data:userRecord[k],dataGrouping:grouping_options,yAxis:1},false)}}}for(var g=0;g<j;g++){if(!dataResult[g+f]){continue}dataResult[g+f].x=e.time[g];dataResult[g+f].y=e.value[g];dataBenchmark[g+f].x=l.time[g];dataBenchmark[g+f].y=l.value[g]}if(m.data.userRecord){for(var k in m.data.userRecord){var c=0;for(var g=0;g<m.data.userRecord[k].time.length;g++){if(!m.data.userRecord[k].time[g]){continue}var o=m.data.userRecord[k].time[g];var n=timeBar[o];userRecord[k][n].x=m.data.userRecord[k].time[g];userRecord[k][n].y=m.data.userRecord[k].value[g];c++}}userRecordOffset=userRecordOffset+c}resultOffset=f+j;if(dataResult.length>0&&resultOffset>0&&dataResult.length>=resultOffset){var h=dataResult[resultOffset-1].x;for(var g=resultOffset;g<dataResult.length;g++){if(dataResult[g].x<h){dataResult[g].x=h;dataBenchmark[g].x=h}else{break}}}if(m.data.state==2){building=0;if(m.data.result.count==0){fillStats();if(!$("#logs-init").hasClass("hidden")){$("#logs-init").addClass("hidden")}toggleNavbar(1);return}}var b=(Math.min(100,(resultOffset/dataResult.length)*100)).toFixed(1);if(b>80){timeoutSpan=500}$("#dailybars-progressbar").css({width:b+"%"});draw(dataResult,dataBenchmark,userRecord);stopResult=false}})}var g_tradeDays=null;var timeBar={};function getRemainNullData(){var a=[];for(var b=0;b<g_tradeDays.length;b++){tick=g_tradeDays[b]*1000;a.push({x:tick,y:null});timeBar[tick]=b}return a}function initChart(){window.startDate=startDate;window.endDate=endDate;dataResult=getRemainNullData();dataBenchmark=getRemainNullData();origDataOffset=0;resultOffset=0;userRecordOffset=0;logOffset=0;errorLogOffset=0;if(chart){chart.destroy();userRecord=null;chart=null}}function draw(a,c,b){chart.series[0].setData(a,false);chart.series[1].setData(c,false);if(b){var d=2;for(var e in b){if(chart.series[d]){chart.series[d].setData(b[e],false)}d++}}chart.redraw()}var grouping_options=null;function newChart(a){grouping_options={enabled:!0,approximation:"average",units:[["week",[1]],["month",[1,2,3,4,6]]],groupPixelWidth:1};var b=[{type:"area",name:"策略收益",color:"#3675c9",fillOpacity:0.2,tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]},{name:"基准收益",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},color:"#ab423e",data:[]}];if(a){for(var c in a){b.push({name:c,data:[],dataGrouping:grouping_options,yAxis:1})}var d=[{height:"45%",lineWidth:2,title:{text:""},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:23,formatter:function(){return this.value+"%"}}},{labels:{align:"right",x:15},title:{text:""},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],top:"55%",height:"45%",offset:0,lineWidth:2}]}else{var d=[{height:"100%",lineWidth:2,title:{text:""},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:23,formatter:function(){return this.value+"%"}}}]}chart=new Highcharts.StockChart({chart:{renderTo:"dailybar-chart-outer-container",events:{tooltipRefresh:function(f){chartHoverPointIndex=chart.hoverPoints[0].index}},animation:Highcharts.svg,marginRight:22},scrollbar:{enabled:false},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],title:{text:""},rangeSelector:{enabled:false},plotOptions:{series:{connectNulls:true,turboThreshold:0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},legend:{align:"center",verticalAlign:"top",borderWidth:0},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"#ecf2fa",xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %Y"}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:120,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}},yAxis:d,series:b});return chart}var chartHoverPointIndex=0;document.onkeydown=function(f){if(typeof chart=="undefined"){return}var d=chart;var c=d.series[0].points.length;switch(f.keyCode){case 37:if(chartHoverPointIndex==0){chartHoverPointIndex=chartHoverPointIndex}else{chartHoverPointIndex=chartHoverPointIndex-1}var b=[];for(var a=0;a<d.series.length;a++){b[a]=d.series[a].points[chartHoverPointIndex]}d.tooltip.refresh(b);break;case 39:if(chartHoverPointIndex==c){chartHoverPointIndex=chartHoverPointIndex}else{chartHoverPointIndex=chartHoverPointIndex+1}var b=[];for(var a=0;a<d.series.length;a++){b[a]=d.series[a].points[chartHoverPointIndex]}d.tooltip.refresh(b);break}};var saving=false;function save(a){if($("#save-span").hasClass("hidden")){return}saving=true;$("#save").attr("disabled","disabled");$("#save-span").addClass("hidden");$("#save-busy-text").css("display","block");Cy.ajax("/algorithm/index/generate?build=2",{data:a,async:false,success:function(c){$("#algorithmId").val(c.data.algorithmId);$("#edit-button").removeClass("disabled");$("#backtest-button").removeClass("disabled");if(parent.location.href.indexOf("?")<0){if(parent.location.href.indexOf("?algorithm")<0){parent.location.href=parent.location.href+"?algorithmId="+c.data.algorithmId}}else{console.log(1);if(parent.location.href.indexOf("?algorithm")<0){var b=parent.location.href.split("?");parent.location.href=b[0]+"?algorithmId="+c.data.algorithmId+"&"+b[1]}}setTimeout(saveDone,1000);setTimeout(unsave,1500);return false},fail:function(b){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:b.msg});return false}})}function saveDone(){saving=false;$("#save-busy-text").css("display","none");$("#save-done-text").css("display","block")}$("#backtest-button").click(function(){if($("#algorithmId").val()){window.location.href="/algorithm/backtest/list?algorithmId="+$("#algorithmId").val()}});$("#edit-button").click(function(){if($("#algorithmId").val()){window.location.href="/algorithm/backtest/buildList?algorithmId="+$("#algorithmId").val()}});if($("#algorithmId").val()){$("#edit-button").removeClass("disabled");$("#backtest-button").removeClass("disabled")}$(".popover-right").popover({placement:"bottom",trigger:"manual",html:true,content:'风险指标有利于您对策略进行客观的评价，<a target="_blank" style="color:#337ab7;font-weight:normal" href="/api#%E9%A3%8E%E9%99%A9%E6%8C%87%E6%A0%87">查看计算公式</a>'}).on("mouseenter",function(){var a=this;$(this).popover("show");$(this).siblings(".popover").on("mouseleave",function(){$(a).popover("hide")})}).on("mouseleave",function(){var a=this;setTimeout(function(){if(!$(".popover:hover").length){$(a).popover("hide")}},100)});